#!/usr/bin/env python
import argparse
import os

os.environ["LOG_PATH"] = os.getenv("LOG_PATH", "/log")
os.environ["OUTPUT_PATH"] = os.getenv("OUTPUT_PATH", "/output")
os.makedirs(os.environ["LOG_PATH"], exist_ok=True)
os.makedirs(os.environ["OUTPUT_PATH"], exist_ok=True)

from flavor.cook.servicer import AggregateServerAppServicer, serve  # noqa: E402

os.environ["PYTHONWARNINGS"] = "ignore"


def main():

    parser = argparse.ArgumentParser()
    parser.add_argument("-m", "--main", type=str, required=True, help="main process command")
    parser.add_argument(
        "--init-once", action="store_true", help="Initialize aggregator just once", default=False
    )
    args, unparsed = parser.parse_known_args()

    app_service = AggregateServerAppServicer(mainProcess=args.main, init_once=args.init_once)
    serve(app_service, stype="server")


if __name__ == "__main__":

    main()
